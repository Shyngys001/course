<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>原始点 академиясы — Денсаулыққа арналған онлайн курстар</title>
  <meta name="description" content="原始点 академиясы: қауіпсіз табиғи әдістерді үйреніп, денсаулықты жақсартыңыз. Онлайн курстар, Kaspi арқылы төлеу, қолдау WhatsApp-та.">
  <meta name="theme-color" content="#008000">
  <meta name="color-scheme" content="light only">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <style>
    /* ===== CSS Variables ===== */
    :root {
      --brand: #008000;
      --brand-dark: #006600;
      --brand-light: #E8F5E8;
      --accent: #0984E3;
      --success: #00B894;
      --warning: #FDCB6E;
      --error: #FF6B6B;
      
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --bg-card: #FFFFFF;
      --bg-overlay: rgba(0, 0, 0, 0.5);
      
      --text-primary: #2D3436;
      --text-secondary: #636E72;
      --text-muted: #B2BEC3;
      
      --border: #DFE6E9;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
      --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.05);
      
      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      
      --spacing: 16px;
      --spacing-sm: 12px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      
      --header-height: 64px;
      --tabbar-height: 72px;
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      
      --transition: all 0.3s ease;
    }

    /* ===== Reset & Base ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 16px;
      overflow-x: hidden;
      transition: var(--transition);
      padding-bottom: var(--tabbar-height);
    }

    /* ===== App Structure ===== */
    .app {
      min-height: 100vh;
      position: relative;
    }

    .page {
      display: none;
      min-height: 100vh;
      padding-bottom: calc(var(--tabbar-height) + var(--safe-area-bottom) + 20px);
    }

    .page.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing);
    }

    /* ===== Header ===== */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      height: var(--header-height);
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 100%;
      padding: 0 var(--spacing);
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--brand);
    }

    .header-title i {
      color: var(--brand);
    }

    .back-button {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: var(--radius);
      background: var(--bg-secondary);
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
    }

    .back-button:hover {
      background: var(--bg-primary);
    }

    /* ===== Tab Bar ===== */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--bg-primary);
      border-top: 1px solid var(--border);
      height: calc(var(--tabbar-height) + var(--safe-area-bottom));
      padding-bottom: var(--safe-area-bottom);
      display: flex;
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.08);
    }

    .tab-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 11px;
      font-weight: 500;
      min-height: 44px;
      padding: 8px 4px;
      position: relative;
      transition: var(--transition);
      background: none;
      border: none;
      cursor: pointer;
    }

    .tab-item i {
      font-size: 20px;
      margin-bottom: 2px;
      transition: var(--transition);
    }

    .tab-item.active {
      color: var(--brand);
    }

    .tab-item.active i {
      color: var(--brand);
      transform: translateY(-2px);
    }

    .tab-item.active::after {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: var(--brand);
      border-radius: 2px;
    }

    /* ===== Common Components ===== */
    .section {
      padding: var(--spacing-xl) 0;
    }

    .section-title {
      margin-bottom: var(--spacing-lg);
    }

    .section-title h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .section-title p {
      color: var(--text-secondary);
      font-size: 15px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      border-radius: var(--radius);
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      font-family: inherit;
      font-size: 15px;
    }

    .btn-primary {
      background: var(--brand);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 128, 0, 0.25);
    }

    .btn-primary:hover {
      background: var(--brand-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 128, 0, 0.3);
    }

    .btn-secondary {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      transform: translateY(-2px);
    }

    .btn-block {
      width: 100%;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid var(--border);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
    }

    /* ===== Hero ===== */
    .hero {
      padding: var(--spacing-xl) 0;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid var(--border);
    }

    .hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: var(--brand-light);
      border-radius: 50%;
      opacity: 0.3;
    }

    .hero::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -10%;
      width: 200px;
      height: 200px;
      background: var(--brand-light);
      border-radius: 50%;
      opacity: 0.2;
    }

    .hero-content {
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .hero-badge {
      display: inline-block;
      padding: 6px 16px;
      background: var(--brand-light);
      color: var(--brand);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: var(--spacing);
      border: 1px solid rgba(0, 128, 0, 0.1);
    }

    .hero h1 {
      font-size: 32px;
      font-weight: 800;
      line-height: 1.2;
      margin-bottom: var(--spacing);
      color: var(--text-primary);
    }

    .hero h1 span {
      color: var(--brand);
    }

    .hero p {
      font-size: 18px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .hero-actions {
      display: flex;
      gap: var(--spacing);
      justify-content: center;
      flex-wrap: wrap;
    }

    /* ===== Courses Grid ===== */
    .academy-modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 60px;
    }

    @media (max-width: 768px) {
      .academy-modules-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .academy-card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      border: none;
    }

    .academy-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-lg);
    }

    .academy-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
    }

    .academy-card-image {
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: #f8fafc;
    }

    .module-bg {
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      height: 180px;
      position: relative;
    }

    .module-label {
      font-size: 1.3rem;
      font-weight: 700;
      text-align: center;
      padding: 0 15px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .academy-card:hover .academy-card-image img {
      transform: scale(1.08);
    }

    .academy-card-content {
      padding: 24px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .academy-card-content h3 {
      color: var(--brand-dark);
      margin-bottom: 16px;
      font-size: 1.3rem;
      font-weight: 700;
      position: relative;
      display: inline-block;
    }

    .academy-card-content h3::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 40px;
      height: 3px;
      background: var(--brand);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    .academy-card:hover .academy-card-content h3::after {
      width: 60px;
    }

    .academy-card-content p {
      color: var(--text-secondary);
      margin-bottom: 20px;
      flex-grow: 1;
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .lesson-bg {
      background: linear-gradient(135deg, var(--brand-light), var(--brand));
    }

    .lesson-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--brand);
      color: #fff;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.5rem;
      box-shadow: var(--shadow);
      z-index: 2;
    }

    /* ===== Lessons ===== */
    .lesson-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing);
      border: 1px solid var(--border);
      margin-bottom: var(--spacing);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
    }

    .lesson-card:hover {
      background: var(--bg-secondary);
      transform: translateY(-4px);
    }

    .lesson-header {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing);
      margin-bottom: var(--spacing);
    }

    .lesson-number-sm {
      width: 40px;
      height: 40px;
      background: var(--brand);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }

    .lesson-info {
      flex: 1;
    }

    .lesson-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .lesson-duration {
      font-size: 14px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .lesson-description {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }

    /* ===== Video Player ===== */
    .video-player-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }

    .video-header {
      padding: var(--spacing);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-sm);
    }

    .video-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing);
    }

    .video-iframe {
      width: 100%;
      max-width: 800px;
      aspect-ratio: 16/9;
      border: none;
      border-radius: var(--radius);
      background: black;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .comments-section {
      padding: var(--spacing);
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    .comment-form {
      margin-bottom: var(--spacing);
    }

    .comment-input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: inherit;
      margin-bottom: var(--spacing);
      resize: vertical;
      min-height: 80px;
      font-size: 15px;
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(0, 128, 0, 0.1);
    }

    .comments-list {
      display: grid;
      gap: var(--spacing);
    }

    .comment-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: var(--spacing);
      border-left: 3px solid var(--brand);
      box-shadow: var(--shadow-sm);
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
      font-weight: 600;
    }

    .comment-author {
      font-weight: 600;
      color: var(--text-primary);
    }

    .comment-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .comment-text {
      color: var(--text-secondary);
      line-height: 1.5;
      font-size: 15px;
    }

    /* ===== FAQ ===== */
    .faq-accordion {
      display: grid;
      gap: var(--spacing);
    }

    .faq-item {
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .faq-question {
      padding: var(--spacing);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .faq-question:hover {
      background: var(--bg-secondary);
    }

    .faq-question i {
      transition: transform 0.3s ease;
      color: var(--text-muted);
    }

    .faq-item.active .faq-question i {
      transform: rotate(180deg);
      color: var(--brand);
    }

    .faq-answer {
      padding: 0 var(--spacing);
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .faq-item.active .faq-answer {
      padding: 0 var(--spacing) var(--spacing);
      max-height: 500px;
    }

    /* ===== Profile ===== */
    .profile-header {
      text-align: center;
      padding: var(--spacing-xl) 0;
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
      color: white;
      border-radius: 0 0 var(--radius-xl) var(--radius-xl);
      margin-bottom: var(--spacing-xl);
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 32px;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .profile-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .profile-email {
      font-size: 14px;
      opacity: 0.9;
    }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing);
      margin: var(--spacing-xl) 0;
      padding: 0 var(--spacing);
    }

    .stat-item {
      text-align: center;
      padding: var(--spacing);
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* ===== Modal ===== */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-overlay);
      backdrop-filter: blur(8px);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      width: 100%;
      max-width: 400px;
      transform: translateY(20px);
      transition: var(--transition);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }

    .modal.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      margin-bottom: var(--spacing-lg);
      text-align: center;
    }

    .modal-header h3 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .modal-header p {
      color: var(--text-secondary);
      font-size: 15px;
    }

    .form-group {
      margin-bottom: var(--spacing);
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 15px;
      transition: var(--transition);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(0, 128, 0, 0.1);
    }

    /* ===== Loading & Error ===== */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
      grid-column: 1 / -1;
      text-align: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error-message {
      text-align: center;
      padding: 60px 20px;
      color: var(--error);
      grid-column: 1 / -1;
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .error-message i {
      font-size: 3rem;
      margin-bottom: 20px;
      color: var(--error);
    }

    .error-message h3 {
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    /* ===== Utility ===== */
    .text-center {
      text-align: center;
    }
    
    .mb {
      margin-bottom: var(--spacing);
    }
    
    .mt {
      margin-top: var(--spacing);
    }

    .fade-in {
      animation: fadeIn 0.7s ease forwards;
      opacity: 0;
    }

    /* ===== Notification ===== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      z-index: 9999;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      max-width: 400px;
      font-weight: 600;
    }

    .notification-success {
      background: var(--success);
      color: white;
    }

    .notification-error {
      background: var(--error);
      color: white;
    }

    .notification-info {
      background: var(--accent);
      color: white;
    }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .hero h1 {
        font-size: 28px;
      }
      
      .hero p {
        font-size: 16px;
      }
      
      .section {
        padding: var(--spacing-lg) 0;
      }
      
      .section-title h2 {
        font-size: 22px;
      }
      
      .hero-actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      .academy-modules-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .profile-stats {
        grid-template-columns: 1fr;
      }

      .video-iframe {
        border-radius: var(--radius);
      }
    }

    @media (min-width: 769px) {
      .tab-bar {
        display: flex;
      }
      
      .academy-modules-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .academy-modules-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ===== Custom Modal ===== */
    .custom-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-overlay);
      backdrop-filter: blur(8px);
      z-index: 3001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .custom-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .custom-modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      width: 100%;
      max-width: 500px;
      transform: translateY(20px);
      transition: var(--transition);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }

    .custom-modal.active .custom-modal-content {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Main Page -->
    <div id="mainPage" class="page active">
      <header class="app-header">
        <div class="header-content">
          <div class="header-title">
            <i class="fas fa-heartbeat"></i>
            <span>原始点 академиясы</span>
          </div>
          <div>
            <button class="btn btn-secondary" onclick="showLoginModal()" id="loginButtonHeader">
              <i class="fas fa-sign-in-alt"></i> Кіру
            </button>
          </div>
        </div>
      </header>

      <main>
        <section class="hero">
          <div class="container">
            <div class="hero-content">
              <span class="hero-badge">Себебін тапсаң-шипасы табылады</span>
              <h1>«Себепті нүкте сауықтыру»<br><span>орталығы</span></h1>
              <p>«Жылуың бар өсесің, өнесің, жылуың жоқ өшесің өлесің»</p>
              <div class="hero-actions">
                <button class="btn btn-primary" onclick="loadModules()">
                  <i class="fas fa-book-open"></i> Курстарды көру
                </button>
              </div>
            </div>
          </div>
        </section>

        <section id="modules" class="section">
          <div class="container">
            <div class="section-title">
              <h2>Онлайн курстар</h2>
              <p>Өз жылдамдығыңызбен үйретіңіз. Үйде-ақ меңгеріңіз</p>
            </div>
            <div class="academy-modules-grid" id="coursesContainer">
              <div class="loading">
                <div class="spinner"></div>
                <p>Курстар жүктелуде...</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- FAQ Page -->
    <div id="faqPage" class="page">
      <header class="app-header">
        <div class="header-content">
          <button class="back-button" onclick="showPage('mainPage')">
            <i class="fas fa-arrow-left"></i>
            Артқа
          </button>
          <div class="header-title">
            <i class="fas fa-question-circle"></i>
            <span>Сұрақ-жауап</span>
          </div>
          <div></div>
        </div>
      </header>

      <main>
        <section class="section">
          <div class="container">
            <div class="section-title">
              <h2>Жиі қойылатын сұрақтар</h2>
              <p>Сіздің барлық сұрақтарыңызға жауап</p>
            </div>
            <div class="faq-accordion">
              <div class="faq-item" onclick="toggleFaq(this)">
                <div class="faq-question">
                  <span>Қалай кірем?</span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Жоғарыдағы «Кіру» батырмасын басып, нөмір мен құпиясөзді енгізесіз.</p>
                </div>
              </div>
              <div class="faq-item" onclick="toggleFaq(this)">
                <div class="faq-question">
                  <span>Төлемнен кейін қолжетімділік?</span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Kaspi чегін WhatsApp арқылы жібересіз — менеджер қолжетімділікті бірден қосады.</p>
                </div>
              </div>
              <div class="faq-item" onclick="toggleFaq(this)">
                <div class="faq-question">
                  <span>Видео ашылмаса?</span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Интернет пен браузер кэшін тексеріңіз немесе бізге жазыңыз.</p>
                </div>
              </div>
              <div class="faq-item" onclick="toggleFaq(this)">
                <div class="faq-question">
                  <span>Курсты қалай сатып аламын?</span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Курсты таңдап, Kaspi арқылы төлеңіз. Төлемнен кейін чекті менеджерге жіберіңіз.</p>
                </div>
              </div>
              <div class="faq-item" onclick="toggleFaq(this)">
                <div class="faq-question">
                  <span>Қанша уақытқа қолжетімді?</span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Курсқа төлегеннен кейін 1 жыл бойы шектеусіз қолжетімділік аласыз.</p>
                </div>
              </div>
              <div class="faq-item" onclick="toggleFaq(this)">
                <div class="faq-question">
                  <span>Қауіпсіз бе?</span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Иә, барлық тәсілдер қауіпсіз және табиғи. Бірақ әрқашан сақтықпен жасаңыз.</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="page">
      <header class="app-header">
        <div class="header-content">
          <button class="back-button" onclick="showPage('mainPage')">
            <i class="fas fa-arrow-left"></i>
            Артқа
          </button>
          <div class="header-title">
            <i class="fas fa-user"></i>
            <span>Профиль</span>
          </div>
          <div></div>
        </div>
      </header>

      <main>
        <div class="profile-header">
          <div class="profile-avatar" id="profileAvatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="profile-name" id="userName">Қонақ</div>
          <div class="profile-email" id="userEmail">Кіру керек</div>
        </div>

        <section class="section">
          <div class="container">
            <div class="profile-stats">
              <div class="stat-item">
                <div class="stat-value" id="statCourses">0</div>
                <div class="stat-label">Курс</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="statLessons">0</div>
                <div class="stat-label">Сабақ</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="statDays">1</div>
                <div class="stat-label">Күн</div>
              </div>
            </div>

            <div class="mb">
              <h3 class="mb">Менің курстарым</h3>
              <div class="card mb" id="myCourses">
                <p style="color: var(--text-secondary); text-align: center; padding: 20px;">Әзірше курс сатып алмадыңыз</p>
              </div>
              <button class="btn btn-primary" onclick="showPage('mainPage')">
                <i class="fas fa-shopping-cart"></i> Курстарды көру
              </button>
            </div>

            <div class="mb">
              <h3 class="mb">Параметрлер</h3>
              <div class="card">
                <div style="display: flex; flex-direction: column; gap: 16px;">
                  <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span>Тема</span>
                    <select class="form-control" style="width: auto; padding: 8px 12px;" id="themeSelect" onchange="changeTheme(this.value)">
                      <option value="light">Ақ</option>
                      <option value="dark">Қара</option>
                    </select>
                  </div>
                  <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span>Тіл</span>
                    <select class="form-control" style="width: auto; padding: 8px 12px;" id="languageSelect">
                      <option value="kk">Қазақша</option>
                      <option value="ru">Орысша</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <button class="btn btn-secondary" id="logoutBtn" style="display: none; width: 100%;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Шығу
              </button>
              <button class="btn btn-primary" id="loginBtn" style="width: 100%;" onclick="showLoginModal()">
                <i class="fas fa-sign-in-alt"></i> Кіру
              </button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Lessons Page -->
    <div id="lessonsPage" class="page">
      <header class="app-header">
        <div class="header-content">
          <button class="back-button" onclick="showPage('mainPage')">
            <i class="fas fa-arrow-left"></i>
            Артқа
          </button>
          <div class="header-title" id="lessonPageTitle">Сабақтар</div>
          <div></div>
        </div>
      </header>

      <main>
        <section class="section">
          <div class="container">
            <div class="section-title">
              <h2 id="moduleTitle">Модуль сабақтары</h2>
              <p id="moduleDescription">Оқу үшін сабақты таңдаңыз</p>
            </div>
            <div class="academy-modules-grid" id="lessonsContainer">
              <div class="loading">
                <div class="spinner"></div>
                <p>Сабақтар жүктелуде...</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Tab Bar -->
    <nav class="tab-bar">
      <button class="tab-item active" onclick="showPage('mainPage')">
        <i class="fas fa-book"></i>
        <span>Курстар</span>
      </button>
      <button class="tab-item" onclick="showPage('faqPage')">
        <i class="fas fa-question-circle"></i>
        <span>FAQ</span>
      </button>
      <button class="tab-item" onclick="showPage('profilePage')">
        <i class="fas fa-user"></i>
        <span>Профиль</span>
      </button>
    </nav>

    <!-- Video Player -->
    <div id="videoPlayerPage" class="video-player-page" style="display: none;">
      <div class="video-header">
        <button class="btn btn-secondary" onclick="closeVideo()">
          <i class="fas fa-times"></i> Жабу
        </button>
        <span id="videoTitle">Бейнесабақ</span>
        <div></div>
      </div>
      <div class="video-content">
        <iframe id="videoPlayer" class="video-iframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
      <div class="comments-section">
        <h3 class="mb">Пікірлер</h3>
        <div class="comment-form">
          <textarea class="comment-input" id="commentInput" placeholder="Пікіріңізді жазыңыз..."></textarea>
          <button class="btn btn-primary btn-block" onclick="addComment()">
            <i class="fas fa-paper-plane"></i> Жіберу
          </button>
        </div>
        <div class="comments-list" id="commentsList">
          <!-- Comments will load here -->
        </div>
      </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Аккаунтқа кіру</h3>
          <p>Курстарға қол жеткізу үшін кіріңіз</p>
        </div>
        <form onsubmit="event.preventDefault(); login()">
          <div class="form-group">
            <label for="phoneInput">Телефон нөмірі</label>
            <input type="tel" class="form-control" id="phoneInput" placeholder="+7 XXX XXX XX XX" required>
          </div>
          <div class="form-group">
            <label for="passwordInput">Құпиясөз</label>
            <input type="password" class="form-control" id="passwordInput" placeholder="Құпиясөз" required>
          </div>
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-sign-in-alt"></i> Кіру
          </button>
        </form>
        <div style="text-align: center; margin-top: 20px;">
          <p style="color: var(--text-secondary); margin-bottom: 12px;">Немесе әлеуметтік желі арқылы</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <a href="https://wa.me/77479894879" target="_blank" class="btn btn-secondary">
              <i class="fab fa-whatsapp"></i>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Modal (for payment etc) -->
    <div class="custom-modal" id="customModal">
      <div class="custom-modal-content" id="customModalContent">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const SESS_URL = 'https://script.google.com/macros/s/AKfycbwp61ZemVXyhVy3s2CBDYnfWBZaVhmsGiqzG9U4i4KGCoNykLNZrHwQRBny6iaAJusZ/exec';
    const CONFIG = {
      spreadsheetId: '1fBxicZo7HkKXpoUVRtZvc628oG7rxLeSgcIgmruTd5Y',
      sheets: { modules:'Модули', lessons:'Видеоуроки', users:'Юзеры', comments:'comment' }
    };
    const COMMENT_URL = 'https://script.google.com/macros/s/AKfycbwiWkQUZHiw9TcQNcXsQxwHBK-Qi6nzFrXQwEEe_NO-SxjNLNwp2e841WzvoxCrGWny/exec';

    // ===== STATE MANAGEMENT =====
    const state = {
      currentUser: null,
      currentModule: null,
      currentVideo: null,
      modules: [],
      lessonsAll: [],
      comments: {},
      currentPage: 'mainPage',
      lessonsFetchedAt: 0,
      postLoginAction: null
    };

    let sessionTimer = null;

    // ===== DOM ELEMENTS =====
    const DOM = {
      pages: document.querySelectorAll('.page'),
      tabItems: document.querySelectorAll('.tab-item'),
      loginModal: document.getElementById('loginModal'),
      customModal: document.getElementById('customModal'),
      customModalContent: document.getElementById('customModalContent'),
      coursesContainer: document.getElementById('coursesContainer'),
      lessonsContainer: document.getElementById('lessonsContainer'),
      lessonPageTitle: document.getElementById('lessonPageTitle'),
      moduleTitle: document.getElementById('moduleTitle'),
      moduleDescription: document.getElementById('moduleDescription'),
      videoPlayerPage: document.getElementById('videoPlayerPage'),
      videoPlayer: document.getElementById('videoPlayer'),
      videoTitle: document.getElementById('videoTitle'),
      commentInput: document.getElementById('commentInput'),
      commentsList: document.getElementById('commentsList'),
      userName: document.getElementById('userName'),
      userEmail: document.getElementById('userEmail'),
      profileAvatar: document.getElementById('profileAvatar'),
      logoutBtn: document.getElementById('logoutBtn'),
      loginBtn: document.getElementById('loginBtn'),
      loginButtonHeader: document.getElementById('loginButtonHeader'),
      statCourses: document.getElementById('statCourses'),
      statLessons: document.getElementById('statLessons'),
      statDays: document.getElementById('statDays'),
      myCourses: document.getElementById('myCourses'),
      themeSelect: document.getElementById('themeSelect'),
      languageSelect: document.getElementById('languageSelect')
    };

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', () => {
      initApp();
    });

    function initApp() {
      // Set theme from localStorage or default
      const savedTheme = localStorage.getItem('theme') || 'light';
      changeTheme(savedTheme);
      DOM.themeSelect.value = savedTheme;
      
      // Set language from localStorage or default
      const savedLang = localStorage.getItem('language') || 'kk';
      DOM.languageSelect.value = savedLang;
      
      // Load modules
      loadModulesWithCounts();
      
      // Check auth
      checkAuth();
      
      // Setup event listeners
      setupEventListeners();
      
      // Setup language change listener
      DOM.languageSelect.addEventListener('change', function() {
        localStorage.setItem('language', this.value);
        showNotification('Тіл өзгерді: ' + this.options[this.selectedIndex].text, 'info');
      });
    }

    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      // Update state
      state.currentPage = pageId;
      
      // Hide all pages
      DOM.pages.forEach(page => {
        page.classList.remove('active');
      });
      
      // Show target page
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active');
      }
      
      // Update tab bar
      updateTabBar(pageId);
      
      // Scroll to top
      window.scrollTo(0, 0);
      
      // Handle page-specific logic
      handlePageShow(pageId);
    }

    function updateTabBar(pageId) {
      // Map page to tab
      const pageToTab = {
        'mainPage': 0,
        'faqPage': 1,
        'profilePage': 2
      };
      
      const tabIndex = pageToTab[pageId];
      if (tabIndex !== undefined) {
        DOM.tabItems.forEach((tab, index) => {
          tab.classList.toggle('active', index === tabIndex);
        });
      }
    }

    function handlePageShow(pageId) {
      switch(pageId) {
        case 'profilePage':
          updateProfilePage();
          break;
        case 'lessonsPage':
          if (state.currentModule) {
            loadLessons(state.currentModule.id);
          }
          break;
      }
    }

    // ===== THEME FUNCTIONS =====
    function changeTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('theme-dark');
        document.documentElement.style.setProperty('--bg-primary', '#1a1a1a');
        document.documentElement.style.setProperty('--bg-secondary', '#2d2d2d');
        document.documentElement.style.setProperty('--bg-card', '#2d2d2d');
        document.documentElement.style.setProperty('--text-primary', '#ffffff');
        document.documentElement.style.setProperty('--text-secondary', '#b3b3b3');
        document.documentElement.style.setProperty('--border', '#404040');
      } else {
        document.body.classList.remove('theme-dark');
        document.documentElement.style.setProperty('--bg-primary', '#FFFFFF');
        document.documentElement.style.setProperty('--bg-secondary', '#F8F9FA');
        document.documentElement.style.setProperty('--bg-card', '#FFFFFF');
        document.documentElement.style.setProperty('--text-primary', '#2D3436');
        document.documentElement.style.setProperty('--text-secondary', '#636E72');
        document.documentElement.style.setProperty('--border', '#DFE6E9');
      }
      localStorage.setItem('theme', theme);
    }

    // ===== GOOGLE SHEETS FUNCTIONS =====
    function extractGoogleDriveId(url) {
      if (!url) return null;
      const patterns = [
        /\/d\/([A-Za-z0-9_-]+)/,
        /\/file\/d\/([A-Za-z0-9_-]+)/,
        /id=([A-Za-z0-9_-]+)/,
        /([A-Za-z0-9_-]{25,})/
      ];
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) return match[1];
      }
      return null;
    }

    async function fetchSheetData(sheet) {
      const url = `https://docs.google.com/spreadsheets/d/${CONFIG.spreadsheetId}/gviz/tq?sheet=${encodeURIComponent(sheet)}&tqx=out:json`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(res.status);
      const text = await res.text();
      const json = JSON.parse(text.slice(text.indexOf('{'), text.lastIndexOf('}') + 1));
      return json.table.rows.map(r => {
        const obj = {};
        r.c.forEach((cell, i) => {
          const key = json.table.cols[i].label.trim();
          obj[key] = cell && cell.v != null ? String(cell.v).trim() : '';
        });
        return obj;
      });
    }

    async function loadModulesWithCounts() {
      try {
        const [modules, lessons] = await Promise.all([
          fetchSheetData(CONFIG.sheets.modules),
          fetchSheetData(CONFIG.sheets.lessons)
        ]);

        state.modules = modules;
        state.lessonsAll = lessons;
        state.lessonsFetchedAt = Date.now();

        const counts = lessons.reduce((a, l) => {
          const m = String(l.module_id);
          a[m] = (a[m] || 0) + 1;
          return a;
        }, {});

        renderModules(modules, counts);
      } catch (err) {
        console.error('Модульдерді жүктеу қатесі:', err);
        DOM.coursesContainer.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Модульдерді жүктеу мүмкін емес</h3>
            <p>Кейінірек қайталап көріңіз</p>
          </div>`;
      }
    }

    function renderModules(modules, lessonCounts) {
      DOM.coursesContainer.innerHTML = '';
      DOM.coursesContainer.className = 'academy-modules-grid';
      
      modules.forEach((mod, i) => {
        const count = lessonCounts[String(mod.id)] || 0;
        const isPurchased = state.currentUser?.purchasedCourses?.includes(parseInt(mod.id)) || false;
        
        const card = document.createElement('div');
        card.className = 'academy-card fade-in';
        card.style.animationDelay = `${i * 0.1}s`;
        card.innerHTML = `
          <div class="academy-card-image module-bg">
            <div class="module-label">${mod.name}</div>
          </div>
          <div class="academy-card-content">
            <h3>${mod.name}</h3>
            <p>${mod.description}</p>
            <p style="margin-top:8px; color:var(--brand); font-weight:600;">Сабақ саны: ${count}</p>
            <button class="btn ${isPurchased ? 'btn-primary' : 'btn-secondary'} view-lessons" 
                    data-module-id="${mod.id}" 
                    data-module-name="${encodeURIComponent(mod.name)}"
                    data-module-description="${encodeURIComponent(mod.description)}">
              <i class="fas ${isPurchased ? 'fa-book-reader' : 'fa-lock'}"></i> 
              ${isPurchased ? 'Сабақтарды қарау' : (mod.price ? `${mod.price} ₸` : 'Курсты алу')}
            </button>
          </div>`;
        DOM.coursesContainer.appendChild(card);
      });

      // Add event listeners to module buttons
      document.querySelectorAll('.view-lessons').forEach(btn => {
        btn.addEventListener('click', async () => {
          const moduleId = btn.dataset.moduleId;
          const moduleName = decodeURIComponent(btn.dataset.moduleName);
          const moduleDescription = decodeURIComponent(btn.dataset.moduleDescription);
          
          // Check if user is logged in
          if (!state.currentUser) {
            showNotification('Бұл модульді көру үшін кіріңіз', 'error');
            showLoginModal();
            return;
          }
          
          // Check if module is purchased
          const isPurchased = state.currentUser?.purchasedCourses?.includes(parseInt(moduleId)) || false;
          
          if (!isPurchased) {
            // Show payment options
            showPaymentOptions(moduleId, moduleName, moduleDescription);
            return;
          }
          
          // User has access, show lessons
          state.currentModule = {
            id: moduleId,
            name: moduleName,
            description: moduleDescription
          };

          DOM.lessonPageTitle.textContent = moduleName;
          DOM.moduleTitle.textContent = `${moduleName} модулінің сабақтары`;
          DOM.moduleDescription.textContent = moduleDescription;
          
          showPage('lessonsPage');
        });
      });
    }

    function loadModules() {
      loadModulesWithCounts();
      showPage('mainPage');
    }

    // ===== PAYMENT FUNCTIONS =====
    function showPaymentOptions(moduleId, moduleName, moduleDescription) {
      const modalContent = `
        <div class="modal-header">
          <h3>Курсты сатып алу</h3>
          <p>"${moduleName}" курсын сатып алыңыз</p>
        </div>
        <div style="margin-bottom: 20px;">
          <p style="color: var(--text-secondary); margin-bottom: 15px;">Курсты сатып алу үшін:</p>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <a href="https://pay.kaspi.kz/pay" class="btn btn-primary" target="_blank" style="text-align: center;">
              <i class="fas fa-link"></i> Kaspi Pay арқылы төлеу
            </a>
            <a href="https://wa.me/77479894879?text=${encodeURIComponent(`Сәлеметсіз бе! "${moduleName}" курсын сатып алғым келеді.`)}" 
               class="btn btn-secondary" target="_blank" style="text-align: center;">
              <i class="fab fa-whatsapp"></i> Менеджерге жазу
            </a>
          </div>
        </div>
        <div style="background: var(--bg-secondary); padding: 15px; border-radius: var(--radius); margin-bottom: 20px;">
          <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">Төлем нұсқаулығы:</p>
          <ol style="color: var(--text-secondary); font-size: 14px; padding-left: 20px;">
            <li>Kaspi Pay арқылы төлеңіз</li>
            <li>Төлем чегін WhatsApp арқылы менеджерге жіберіңіз</li>
            <li>Менеджер сізге қолжетімділікті қосады</li>
          </ol>
        </div>
        <button class="btn btn-secondary btn-block" onclick="hideCustomModal()">
          <i class="fas fa-times"></i> Жабу
        </button>
      `;
      
      showCustomModal(modalContent);
    }

    // ===== LESSONS FUNCTIONS =====
    async function loadLessons(moduleId) {
      DOM.lessonsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Сабақтар жүктелуде...</p></div>';
      DOM.lessonsContainer.className = 'academy-modules-grid';

      // Check if user has access to this module
      const isPurchased = state.currentUser?.purchasedCourses?.includes(parseInt(moduleId)) || false;
      
      if (!isPurchased) {
        DOM.lessonsContainer.innerHTML = `
          <div class="error-message" style="grid-column: 1 / -1;">
            <i class="fas fa-lock" style="font-size: 3rem; margin-bottom: 20px; color: var(--error);"></i>
            <h3>Бұл модульге қолжетім жоқ</h3>
            <p style="margin-bottom: 20px;">Бұл модульді көру үшін курсты сатып алуыңыз керек</p>
            <button class="btn btn-primary" onclick="showPaymentOptions('${moduleId}', '${state.currentModule?.name || ''}', '${state.currentModule?.description || ''}')">
              <i class="fas fa-shopping-cart"></i> Курсты сатып алу
            </button>
          </div>`;
        return;
      }

      // User has access, load lessons
      const needRefresh = !Array.isArray(state.lessonsAll) ||
        (Date.now() - state.lessonsFetchedAt > 2 * 60 * 1000);
      
      if (needRefresh) {
        try {
          const fresh = await fetchSheetData(CONFIG.sheets.lessons);
          state.lessonsAll = fresh;
          state.lessonsFetchedAt = Date.now();
          const subset = fresh.filter(x => String(x.module_id) === String(moduleId));
          renderLessons(subset);
        } catch (e) {
          console.error('Сабақтарды жүктеу қатесі:', e);
          DOM.lessonsContainer.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i><h3>Сабақтарды жүктеу мүмкін емес</h3></div>';
        }
      } else {
        const subset = state.lessonsAll.filter(x => String(x.module_id) === String(moduleId));
        renderLessons(subset);
      }
    }

    function renderLessons(lessons) {
      if (!lessons.length) {
        DOM.lessonsContainer.innerHTML = `
          <div class="error-message">
            <i class="fas fa-video"></i>
            <h3>Сабақтар табылмады</h3>
            <p>Әзірше осы модульге сабақ жоқ</p>
          </div>`;
        return;
      }
      
      DOM.lessonsContainer.innerHTML = '';
      lessons.forEach((l, i) => {
        const card = document.createElement('div');
        card.className = 'academy-card fade-in';
        card.style.animationDelay = `${i * 0.1}s`;
        card.innerHTML = `
          <div class="academy-card-image lesson-bg">
            <div class="lesson-number">${i + 1}</div>
          </div>
          <div class="academy-card-content">
            <h3>${l.name}</h3>
            <p>${l.description}</p>
            <div style="display:flex; gap:12px; margin-top:20px;">
              <button class="btn btn-primary play-video" 
                      data-lesson-id="${l.id}" 
                      data-video-url="${l.video_url || ''}"
                      data-lesson-title="${encodeURIComponent(l.name)}">
                <i class="fas fa-play-circle"></i> Қарау
              </button>
              ${l.pdf_url ? `<a href="${l.pdf_url}" class="btn btn-secondary" target="_blank"><i class="fas fa-file-pdf"></i> Презентация</a>` : ''}
            </div>
          </div>`;
        DOM.lessonsContainer.appendChild(card);
      });
      
      document.querySelectorAll('.play-video').forEach(btn => {
        btn.addEventListener('click', () => playVideo(btn));
      });
    }

    // ===== VIDEO PLAYER FUNCTIONS =====
    function playVideo(button) {
      const videoUrl = button.dataset.videoUrl;
      const lessonTitle = decodeURIComponent(button.dataset.lessonTitle);
      const driveId = extractGoogleDriveId(videoUrl);
      
      if (!driveId) {
        showNotification('Бейне табылмады', 'error');
        return;
      }
      
      state.currentVideo = { id: driveId, title: lessonTitle };
      
      // Update video player
      DOM.videoTitle.textContent = lessonTitle;
      DOM.videoPlayer.src = `https://drive.google.com/file/d/${driveId}/preview`;
      
      // Show video player
      DOM.videoPlayerPage.style.display = 'flex';
      
      // Load comments
      loadComments(driveId);
    }

    function closeVideo() {
      // Stop video
      DOM.videoPlayer.src = '';
      
      // Hide video player
      DOM.videoPlayerPage.style.display = 'none';
      
      // Clear comment input
      if (DOM.commentInput) {
        DOM.commentInput.value = '';
      }
    }

    // ===== COMMENTS FUNCTIONS =====
    async function loadComments(videoId) {
      DOM.commentsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Пікірлер жүктелуде...</p></div>';
      
      try {
        const all = await fetchSheetData(CONFIG.sheets.comments);
        const comments = all.filter(c => String(c.video_id) === String(videoId));
        
        DOM.commentsList.innerHTML = comments.length ? 
          comments.map(comment => `
            <div class="comment-card">
              <div class="comment-header">
                <div class="comment-avatar">
                  ${comment.user ? comment.user.charAt(0).toUpperCase() : '?'}
                </div>
                <div>
                  <div class="comment-author">${comment.user || 'Қолданушы'}</div>
                  <div class="comment-date">${comment.date || ''}</div>
                </div>
              </div>
              <div class="comment-text">${comment.comment || ''}</div>
            </div>
          `).join('') : 
          '<div class="comment-card"><p style="color: var(--text-muted); text-align: center;">Әзірше пікір жоқ</p></div>';
      } catch (error) {
        console.error('Пікірлерді жүктеу қатесі:', error);
        DOM.commentsList.innerHTML = '<div class="comment-card"><p style="color: var(--error); text-align: center;">Пікірлерді жүктеу мүмкін емес</p></div>';
      }
    }

    async function addComment() {
      if (!state.currentVideo || !DOM.commentInput) return;
      
      const text = DOM.commentInput.value.trim();
      if (!text) {
        showNotification('Пікірді енгізіңіз', 'error');
        return;
      }
      
      if (!state.currentUser) {
        showNotification('Пікір қалдыру үшін кіріңіз', 'error');
        showLoginModal();
        return;
      }
      
      try {
        const url = COMMENT_URL + `?action=add&video_id=${encodeURIComponent(state.currentVideo.id)}&user=${encodeURIComponent(state.currentUser.name)}&comment=${encodeURIComponent(text)}`;
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
          showNotification('Пікіріңіз қосылды!', 'success');
          DOM.commentInput.value = '';
          loadComments(state.currentVideo.id);
        } else {
          showNotification('Пікір қосу қатесі', 'error');
        }
      } catch (error) {
        console.error('Пікір қосу қатесі:', error);
        showNotification('Пікір қосу мүмкін емес', 'error');
      }
    }

    // ===== AUTH FUNCTIONS =====
    async function checkAuth() {
      const user = localStorage.getItem('eduplatform_user');
      if (user) {
        try {
          state.currentUser = JSON.parse(user);
          // Verify session
          const ok = await verifySession();
          if (ok) {
            updateUserUI();
            startHeartbeat();
            // Refresh modules to show purchased status
            loadModulesWithCounts();
          } else {
            forceLogout('Сессия аяқталды');
          }
        } catch (error) {
          console.error('Аутентификация қатесі:', error);
          forceLogout();
        }
      }
    }

    async function login() {
      const phone = document.getElementById('phoneInput').value;
      const password = document.getElementById('passwordInput').value;
      
      if (!phone || !password) {
        showNotification('Барлық өрістерді толтырыңыз', 'error');
        return;
      }
      
      try {
        const url = `${SESS_URL}?action=login&login=${encodeURIComponent(phone)}&password=${encodeURIComponent(password)}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.ok) {
          state.currentUser = { 
            name: data.name || phone, 
            login: phone, 
            token: data.token,
            purchasedCourses: data.purchasedCourses || []
          };
          
          localStorage.setItem('eduplatform_user', JSON.stringify(state.currentUser));
          updateUserUI();
          hideLoginModal();
          showNotification('Сәтті кірдіңіз!', 'success');
          startHeartbeat();
          
          // Refresh modules to show purchased status
          loadModulesWithCounts();
          
          // Execute post-login action if any
          if (state.postLoginAction) {
            state.postLoginAction();
            state.postLoginAction = null;
          }
        } else {
          showNotification('Қате логин немесе құпиясөз', 'error');
        }
      } catch (error) {
        console.error('Кіру қатесі:', error);
        showNotification('Сервер қолжетімсіз', 'error');
      }
    }

    async function verifySession() {
      if (!state.currentUser) return false;
      
      try {
        const res = await fetch(
          `${SESS_URL}?action=verify&login=${encodeURIComponent(state.currentUser.login)}&token=${encodeURIComponent(state.currentUser.token)}`,
          { cache: 'no-store' }
        );
        const data = await res.json();
        return !!data.ok;
      } catch {
        return false;
      }
    }

    function startHeartbeat() {
      if (sessionTimer) clearInterval(sessionTimer);
      
      sessionTimer = setInterval(async () => {
        if (!state.currentUser) return;
        
        try {
          const ok = await verifySession();
          if (!ok) {
            forceLogout('Сессия аяқталды');
          }
        } catch {
          // Ignore heartbeat errors
        }
      }, 30000);
    }

    function forceLogout(message) {
      if (state.currentUser) {
        fetch(`${SESS_URL}?action=logout&login=${encodeURIComponent(state.currentUser.login)}&token=${encodeURIComponent(state.currentUser.token)}`)
          .catch(() => {});
      }
      
      localStorage.removeItem('eduplatform_user');
      state.currentUser = null;
      
      if (sessionTimer) {
        clearInterval(sessionTimer);
        sessionTimer = null;
      }
      
      updateUserUI();
      
      if (message) {
        showNotification(message, 'info');
      }
      
      // Refresh modules to show lock status
      loadModulesWithCounts();
    }

    function logout() {
      forceLogout('Сіз жүйеден шықтыңыз');
    }

    function updateUserUI() {
      const isLoggedIn = !!state.currentUser;
      
      if (DOM.userName) {
        DOM.userName.textContent = isLoggedIn ? state.currentUser.name : 'Қонақ';
      }
      
      if (DOM.userEmail) {
        DOM.userEmail.textContent = isLoggedIn ? state.currentUser.login : 'Кіру керек';
      }
      
      if (DOM.profileAvatar && isLoggedIn && state.currentUser.name) {
        DOM.profileAvatar.innerHTML = state.currentUser.name.charAt(0).toUpperCase();
      }
      
      if (DOM.logoutBtn) {
        DOM.logoutBtn.style.display = isLoggedIn ? 'block' : 'none';
      }
      
      if (DOM.loginBtn) {
        DOM.loginBtn.style.display = isLoggedIn ? 'none' : 'block';
      }
      
      if (DOM.loginButtonHeader) {
        DOM.loginButtonHeader.style.display = isLoggedIn ? 'none' : 'inline-flex';
      }
      
      // Update stats if logged in
      if (isLoggedIn) {
        const purchasedCount = state.currentUser.purchasedCourses?.length || 0;
        DOM.statCourses.textContent = purchasedCount;
        DOM.statLessons.textContent = state.lessonsAll.filter(l => 
          state.currentUser.purchasedCourses?.includes(parseInt(l.module_id))
        ).length;
        DOM.statDays.textContent = '1';
        
        updateMyCourses();
      } else {
        DOM.statCourses.textContent = '0';
        DOM.statLessons.textContent = '0';
        DOM.statDays.textContent = '0';
        DOM.myCourses.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Әзірше курс сатып алмадыңыз</p>';
      }
    }

    function updateMyCourses() {
      if (!state.currentUser || !state.currentUser.purchasedCourses) return;
      
      const purchasedModules = state.modules.filter(m => 
        state.currentUser.purchasedCourses.includes(parseInt(m.id))
      );
      
      if (purchasedModules.length === 0) {
        DOM.myCourses.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Әзірше курс сатып алмадыңыз</p>';
        return;
      }
      
      DOM.myCourses.innerHTML = purchasedModules.map(module => `
        <div style="padding: 12px; border-bottom: 1px solid var(--border);">
          <h4 style="margin-bottom: 4px;">${module.name}</h4>
          <p style="font-size: 14px; color: var(--text-muted);">${module.description}</p>
          <button class="btn btn-primary" style="margin-top: 8px; font-size: 14px; padding: 8px 16px;"
                  onclick="openModule(${module.id})">
            <i class="fas fa-book-reader"></i> Жалғастыру
          </button>
        </div>
      `).join('');
    }

    function updateProfilePage() {
      updateUserUI();
    }

    // Open module from profile
    function openModule(moduleId) {
      const module = state.modules.find(m => m.id == moduleId);
      if (!module) return;

      state.currentModule = {
        id: module.id,
        name: module.name,
        description: module.description
      };

      DOM.lessonPageTitle.textContent = module.name;
      DOM.moduleTitle.textContent = `${module.name} модулінің сабақтары`;
      DOM.moduleDescription.textContent = module.description;

      showPage('lessonsPage');
    }

    // ===== MODAL FUNCTIONS =====
    function showLoginModal() {
      DOM.loginModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function hideLoginModal() {
      DOM.loginModal.classList.remove('active');
      document.body.style.overflow = '';
      document.getElementById('phoneInput').value = '';
      document.getElementById('passwordInput').value = '';
    }

    function showCustomModal(content) {
      DOM.customModalContent.innerHTML = content;
      DOM.customModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function hideCustomModal() {
      DOM.customModal.classList.remove('active');
      document.body.style.overflow = '';
    }

    // ===== FAQ FUNCTIONS =====
    function toggleFaq(element) {
      element.classList.toggle('active');
    }

    // ===== NOTIFICATION FUNCTIONS =====
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 10);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(120%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ===== EVENT LISTENERS SETUP =====
    function setupEventListeners() {
      // Close modal when clicking outside
      DOM.loginModal.addEventListener('click', (e) => {
        if (e.target === DOM.loginModal) {
          hideLoginModal();
        }
      });

      DOM.customModal.addEventListener('click', (e) => {
        if (e.target === DOM.customModal) {
          hideCustomModal();
        }
      });

      // Close modal with Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (DOM.loginModal.classList.contains('active')) {
            hideLoginModal();
          }
          if (DOM.customModal.classList.contains('active')) {
            hideCustomModal();
          }
          if (DOM.videoPlayerPage.style.display === 'flex') {
            closeVideo();
          }
        }
      });

      // Enter key to submit comment
      if (DOM.commentInput) {
        DOM.commentInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && e.ctrlKey) {
            addComment();
          }
        });
      }
    }

    // ===== GLOBAL FUNCTIONS =====
    window.showPage = showPage;
    window.showLoginModal = showLoginModal;
    window.toggleFaq = toggleFaq;
    window.closeVideo = closeVideo;
    window.addComment = addComment;
    window.logout = logout;
    window.loadModules = loadModules;
    window.openModule = openModule;
    window.hideCustomModal = hideCustomModal;
    window.changeTheme = changeTheme;
  </script>
</body>
</html>